
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vip Acayucan|Los mejores</title>
    
    <!-- Seguridad HTTPS -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Vinculaci√≥n de Estilos -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Librer√≠as Externas -->
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Lato:wght@300;400;700;900&family=Montserrat:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>

    <!-- =========================================
         0. COMPONENTES FLOTANTES
         ========================================= -->
    
    <!-- Bot√≥n Volver Arriba -->
    <button id="btn-back-to-top" class="btn-floating-top" onclick="irArriba()" title="Subir" aria-label="Volver arriba">
        <i class="ph ph-arrow-up"></i>
    </button>

    <!-- Notificaci√≥n Toast
         USABLE: Cambia el texto por defecto si quieres, pero muestra mensajes
         din√°micos con la funci√≥n `mostrarToast(mensaje)` en JS. Se oculta por
         defecto y usa la clase `show` para mostrarse. -->
    <div id="toast-notification" class="toast" role="status" aria-live="polite" style="display:none;">
        <div class="toast-content">
            <i class="ph ph-check-circle-fill"></i>
            <span id="toast-message">Acci√≥n realizada correctamente</span>
        </div>
    </div>

    <!-- Confirmaci√≥n de √©xito (alerta animada con flecha verde) -->
    <div id="success-alert" class="success-alert" aria-hidden="true">
        <div class="success-card">
            <div class="success-icon"><i class="ph ph-arrow-up-right"></i></div>
            <div class="success-text" id="success-text">Agregado exitosamente</div>
        </div>
    </div>

    <!-- Alerta Personalizada (CORREGIDA: Oculta por defecto) -->
    <div id="custom-alert" class="custom-alert-overlay" style="display: none;">
        <div class="custom-alert-box">
            <div class="alert-icon"><i class="ph ph-warning-circle"></i></div>
            <h3 id="alert-title">Atenci√≥n</h3>
            <p id="alert-message">Mensaje...</p>
            <button class="btn-alert" onclick="cerrarAlerta()">ENTENDIDO</button>
        </div>
    </div>

    <!-- =========================================
         1. TOP TICKER
         ========================================= -->
    <div class="top-ticker">
        <div class="ticker-wrapper">
            <button class="ticker-control" onclick="cambiarMensaje(-1)"><i class="ph ph-caret-left"></i></button>
            <div class="ticker-text" id="ticker-display" onclick="toggleTickerPause()"></div>
            <button class="ticker-control" onclick="cambiarMensaje(1)"><i class="ph ph-caret-right"></i></button>
        </div>
    </div>

    <!-- =========================================
         2. NAVBAR
         ========================================= -->
    <nav data-aos="fade-down" data-aos-duration="800">
        <div class="nav-content">
            <div class="buscador-container">
                <div class="input-wrapper">
                    <input type="text" id="input-busqueda" placeholder="Buscar productos..." onkeyup="filtrarBusqueda()" onkeypress="verificarEnter(event)" autocomplete="off">
                    <i class="ph ph-magnifying-glass icono-lupa"></i>
                </div>
                <div id="resultados-busqueda" class="lista-resultados"></div>
            </div>

            <div class="nav-buttons">
                <button class="btn-icon-nav" id="btn-carrito" onclick="abrirCarrito()">
                    <i class="ph ph-shopping-cart"></i>
                    <span id="carrito-count" class="badge-count">0</span>
                </button>
                <button class="btn-inicio" onclick="irAlInicio()"><i class="ph ph-house"></i></button>
            </div>
        </div>
    </nav>

    <!-- =========================================
         3. PANTALLA PRINCIPAL (PORTADAS)
         ========================================= -->
    <section id="seccion-categorias" class="pantalla-activa">
        <header data-aos="zoom-in" data-aos-duration="1200">
            <div class="header-overlay">
                <img src="img/wakalogo.png" alt="Logo" class="logo-principal">
                <h2 class="subtitulo-vip">waka vapes</h2>
                <div class="separador-dorado"></div>
                <p class="slogan">CALIDAD & EXCLUSIVIDAD</p>
            </div>
        </header>

        <div class="contenedor-categorias" id="contenedor-categorias-dinamico">
            <div class="tarjeta-vape-principal" onclick="mostrarCatalogoCompleto()">
                <div class="tarjeta-vape-imagen">
                    <img src="Imagenes/vapes.jpeg" alt="Cat√°logo Waka Vapes">
                </div>
                <div class="tarjeta-vape-titulo">
                    <h2>!VAPES MAYOREO; <i class="ph ph-arrow-right"></i></h2>
                </div>
            </div>
        </div>
    </section>

    <!-- =========================================
         4. PANTALLA GRID (PRODUCTOS)
         ========================================= -->
    <section id="seccion-grid" class="pantalla-oculta">
        <div class="grid-header-spacer"></div>
        <div class="grid-productos" id="grid-productos"></div>
        <div class="espacio-final"></div>
    </section>

    <!-- =========================================
         5. MODAL DE PEDIDO
         ========================================= -->
    <div id="modal-pedido" class="modal">
        <div class="modal-content">
            <button class="cerrar-modal" onclick="cerrarModal()"><i class="ph ph-x"></i></button>
            <div class="modal-body">
                <div class="producto-header">
                    <div class="producto-imagen-grande">
                        <img id="modal-img" src="" alt="Producto">
                    </div>
                    <div class="producto-info-base">
                        <h2 id="modal-titulo-producto">Nombre</h2>
                        <p id="modal-modelo-producto" class="modelo-texto">Modelo</p>
                        <div class="precio-container">
                             <div id="contenedor-precio-modal"></div>
                             <span class="stock-badge"><i class="ph ph-check-circle"></i> Disponible</span>
                        </div>
                    </div>
                </div>
                <hr class="separador-modal">
                <div class="formulario-pedido">
                    <div class="grupo-input">
                        <label id="titulo-variantes">Opci√≥n:</label>
                        <div id="contenedor-variantes"></div>
                        <input type="hidden" id="variante-seleccionada-valor">
                    </div>
                    <div class="fila-controles">
                        <div class="control-cantidad-wrapper">
                            <label>Cantidad</label>
                            <div class="control-cantidad">
                                <button class="btn-cant" type="button" onclick="cambiarCantidad(-1)"><i class="ph ph-minus"></i></button>
                                <input type="number" id="cantidad-seleccionada" value="1" min="1" max="10" readonly>
                                <button class="btn-cant" type="button" onclick="cambiarCantidad(1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <div class="metodo-pago-wrapper">
                            <label>Pago</label>
                            <div class="toggle-pago">
                                <input type="radio" name="pago" id="pago-transf" value="Transferencia" checked>
                                <label for="pago-transf">Transf.</label>
                                <input type="radio" name="pago" id="pago-efectivo" value="Efectivo">
                                <label for="pago-efectivo">Efectivo</label>
                            </div>
                        </div>
                    </div>
                    <!-- Orden de posici√≥n (editable s√≥lo en c√≥digo) -->
                    <div class="footer-compra-sticky">
                        <div class="total-final">
                            <span>Total Estimado:</span>
                            <span id="total-precio">$0</span>
                        </div>
                        <div style="display:flex; gap:8px; flex-direction:column;">
                            <button id="btn-agregar-carrito-modal" class="boton-pedir" onclick="handleCarritoToggle();" title="Agregar al carrito">
                                <i class="ph ph-shopping-cart"></i> Agregar al carrito
                            </button>
                            <button id="btn-whatsapp-modal" class="boton-whatsapp-modal" onclick="enviarWhatsapp();">
                                <i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Comprar ya</span>
                            </button>
                        </div>
                    </div>
                    <div id="advertencia-sobre-pedido-modal" class="advertencia-pago" style="display:none; background: rgba(255, 193, 7, 0.15); border: 1px solid rgba(255, 193, 7, 0.4); color: #ffc107; padding: 12px; border-radius: 8px; margin-top: 10px;">
                        <i class="ph ph-warning" style="margin-right: 6px;"></i>
                        <strong>‚ö†Ô∏è Sobre Pedido:</strong> Requiere anticipo del 50%. El pedido estar√° listo en aproximadamente 7 d√≠as.
                    </div>
                    <div class="advertencia-pago">Todo precio ser√° verificado por producto</div>
                </div>
                <div class="seccion-recomendados">
                    <div class="header-recomendados">
                        <h3>Tambi√©n te podr√≠a interesar</h3>
                        <div class="controles-scroll">
                            <button onclick="scrollRecomendados(-1)"><i class="ph ph-caret-left"></i></button>
                            <button onclick="scrollRecomendados(1)"><i class="ph ph-caret-right"></i></button>
                        </div>
                    </div>
                    <div class="grid-recomendados-wrapper">
                        <div class="grid-recomendados" id="grid-recomendados"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating WhatsApp Button -->
    <button id="whatsapp-floating" class="btn-whatsapp" onclick="toggleFloatingCart()" aria-label="Abrir carrito">
        <i class="ph ph-whatsapp-logo"></i>
        <span id="whatsapp-badge" class="whatsapp-badge">0</span>
    </button>

    <!-- Floating cart panel -->
    <div id="floating-cart-panel" class="floating-cart-panel" style="display:none;" aria-hidden="true">
        <button class="cerrar-flotante cerrar-flotante-fab" onclick="closeFloatingCart()" aria-label="Cerrar carrito">
            <i class="ph ph-x"></i>
        </button>
        <div class="floating-cart-header">
            <strong>Tu Pedido</strong>
            <button class="cerrar-flotante" onclick="closeFloatingCart()"><i class="ph ph-x"></i></button>
        </div>
        <!-- compact floating cart header area (no inputs) -->
        <div class="floating-cart-subtitle">
            <div>Revisa tu pedido y confirma</div>
        </div>
        <div id="floating-cart-list" class="floating-cart-list"></div>
        <div id="sobre-pedido-advertencia" class="advertencia-sobre-pedido" style="display:none;">
            <i class="ph ph-warning"></i>
            <div>
                <strong>‚ö†Ô∏è Importante:</strong> Los productos sobre pedido requieren un anticipo del 50% para procesar tu orden. El pedido estar√° listo aproximadamente 7 d√≠as despu√©s del pago.
            </div>
        </div>
        <div class="floating-cart-footer">
            <div class="floating-total">Total: <span id="floating-total">$0</span></div>
            <div class="floating-actions">
                <button id="btn-hacer-pedido" class="btn-primary" onclick="sendWholeOrderWhatsApp()">
                    <i class="ph ph-whatsapp-logo" style="margin-right:6px; font-size:1.1rem;"></i>
                    Pedir Ahora
                </button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante para hacer pedido desde el carrito -->
    <button id="btn-order-now-floating" class="btn-order-now" onclick="sendWholeOrderWhatsApp()" style="display:none;">Comprar ya</button>

    <!-- Prompt de correo para factura -->
    <div id="email-prompt" class="custom-alert-overlay" style="display:none; z-index:3000;">
        <div class="custom-alert-box" style="max-width: 380px;">
            <div class="alert-icon"><i class="ph ph-envelope-simple"></i></div>
            <h3>Correo para factura</h3>
            <p>Escribe el correo del cliente. Se enviar√° la factura y copia a la tienda antes de abrir WhatsApp.</p>
            <input type="email" id="email-prompt-input" placeholder="ejemplo@(gmail, outlook, hotmail).com" autocomplete="email" class="input-modal-texto" style="margin:12px 0;">
            <div style="display:flex; gap:10px; width:100%;">
                <button class="btn-alert" style="background:#444;" onclick="cerrarPromptCorreo()">Cancelar</button>
                <button class="btn-alert" onclick="confirmarPromptCorreo()">Continuar</button>
            </div>
        </div>
    </div>

    <footer>
        <p class="footer-logo">VP</p>
        <p class="copyright">¬© 2025 Vip Acayucan - Todos los derechos reservados</p>
    </footer>

    <!-- =================================================================
         L√ìGICA JAVASCRIPT
         ================================================================= -->
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        // Inicializar AOS con seguridad
        try {
            AOS.init({ once: true, offset: 50, duration: 800 });
        } catch (e) {
            console.log("Error iniciando animaciones, modo seguro activado");
        }

        const formatearDinero = (cantidad) => {
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(cantidad);
        };

        // TICKER: mensajes y tiempo de rotaci√≥n (necesarios para iniciarTicker)
        const MENSAJES_TICKER = [
            'Los proveedores No.1',
            'Precios de remate ',
            '‚ö° Aprovecha ya compra ahora ‚ö°',
            'Pedidos al <span class="ticker-phone">924 127 7313</span> üìû',
            ' Waka Vapes üëë'
        ];
        const TIEMPO_ROTACION = 4000; // ms

        // ============================================================
        // AJUSTES R√ÅPIDOS (EDITA AQU√ç PARA ACTIVAR/DESACTIVAR)
        // - mostrarCTAPublicidad: bot√≥n "Click aqu√≠" en la tarjeta de publicidad
        // - pausarVideosFueraDeVista: usa IntersectionObserver para pausar el video si no se ve
        // - mostrarBackToTop: muestra el bot√≥n flotante para volver arriba
        // ============================================================
        const AJUSTES_RAPIDOS = {
            mostrarCTAPublicidad: true,
            pausarVideosFueraDeVista: true,
            mostrarBackToTop: true
        };

        // Endpoint de correo (Apps Script) y copia a tienda
        const WHATSAPP_PHONE = '529241277313';
        const EMAIL_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyz0vTqyKhETM0aXIc_GkR3Djk63NDEqqpPDxwwWVzkzEjW6ZhLNI6TroYi2Vmxyvc/exec';
        const EMAIL_CC = 'vpacayucan@gmail.com'; // Copia para la tienda
        const EMAIL_COOLDOWN_MS = 30000; // 30s entre env√≠os
        let _emailCooldownUntil = 0;
        let _pendingAction = null; // 'carrito' o 'modal'

        // =================================================================
        // === ZONAS SEGUROS PARA EDITAR ===
        // - CONFIG_SECCIONES: tarjetas de portada (t√≠tulos, subt√≠tulos, im√°genes)
        // - MENSAJES_TICKER: l√≠neas que aparecen en el ticker superior
        // - listaProductos: cat√°logo de productos (nombre, precio, imagen, variantes)
        // - Tel√©fono WhatsApp: modificar la variable `telefono` dentro de
        //   `enviarWhatsapp()` y `sendWholeOrderWhatsApp()` cuando sea necesario.
        // =================================================================
        const CONFIG_SECCIONES = [
            {
                id: 'vapes',
                titulo: 'Cat√°logo Waka Vapes',
                subtitulo: 'Todas nuestras variedades disponibles',
                img: 'Imagenes/vapes.jpeg',
                disponible: true,
                visible: true,
                orden: 1
            }
        ];

        const listaProductos = [
            // --- VAPES (50 Items) ---
            { id: 1, categoria: 'vapes', activo: true, orden: 1, nombre: "Waka 6000", modelo: "Recargable", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Sand√≠a Ice", disponible: true }, { nombre: "Mango Tropical", disponible: true }, { nombre: "Uva Morada", disponible: true }, { nombre: "Fresa Kiwi", disponible: true }
            ]},
            { id: 2, categoria: 'vapes', activo: true, orden: 2, nombre: "ElfBar BC5000", modelo: "5000 Puffs", precio: 350, precioOriginal: 450, enPromocion: true, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: [
                { nombre: "Blue Razz", disponible: true }, { nombre: "Menta Fresca", disponible: true }, { nombre: "Pi√±a Colada", disponible: true }, { nombre: "Melocot√≥n Ice", disponible: true }
            ]},
            { id: 3, categoria: 'vapes', activo: true, orden: 3, nombre: "Lost Mary", modelo: "OS5000", precio: 380, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: [
                { nombre: "Limonada Rosa", disponible: true }, { nombre: "Mango Durazno", disponible: true }, { nombre: "Sand√≠a Fresa", disponible: true }, { nombre: "Uva Ice", disponible: true }
            ]},
            { id: 4, categoria: 'vapes', activo: true, orden: 4, nombre: "Maskking High", modelo: "Pro Max", precio: 250, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: [
                { nombre: "Cherry Cola", disponible: true }, { nombre: "Manzana Verde", disponible: true }, { nombre: "Fresa Banana", disponible: true }, { nombre: "Kiwi Pasi√≥n", disponible: true }
            ]},
            { id: 5, categoria: 'vapes', activo: true, orden: 5, nombre: "Geek Bar", modelo: "Pulse 15k", precio: 420, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: [
                { nombre: "Dragon Fruit", disponible: true }, { nombre: "Lichi Ice", disponible: true }, { nombre: "Mora Azul", disponible: true }, { nombre: "Mel√≥n Miel", disponible: true }
            ]},
            { id: 6, categoria: 'vapes', activo: true, orden: 6, nombre: "Oxbar", modelo: "Magic Maze", precio: 410, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: [
                { nombre: "Guayaba Ice", disponible: true }, { nombre: "Fresa Crema", disponible: true }, { nombre: "Mango Menta", disponible: true }, { nombre: "Naranja Mandarina", disponible: true }
            ]},
            { id: 7, categoria: 'vapes', activo: true, orden: 7, nombre: "Pluto", modelo: "7000 Puffs", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: [
                { nombre: "Cereza Limonada", disponible: true }, { nombre: "Frutos Rojos", disponible: true }, { nombre: "Mango Ice", disponible: true }, { nombre: "Grape Mint", disponible: true }
            ]},
            { id: 8, categoria: 'vapes', activo: true, orden: 8, nombre: "Vape Soul", modelo: "Smile 2", precio: 280, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: [
                { nombre: "Chicle Menta", disponible: true }, { nombre: "Algod√≥n Dulce", disponible: true }, { nombre: "Caramelo", disponible: true }, { nombre: "Vainilla Crema", disponible: true }
            ]},
            { id: 9, categoria: 'vapes', activo: true, orden: 9, nombre: "Ignite", modelo: "V50", precio: 450, precioOriginal: 500, enPromocion: true, img: "https://images.unsplash.com/photo-1622699292376-788b22e430f7?q=80&w=800", sabores: [
                { nombre: "Banana Ice", disponible: true }, { nombre: "Papaya", disponible: true }, { nombre: "Coco Pi√±a", disponible: true }, { nombre: "Maracuy√°", disponible: true }
            ]},
            { id: 10, categoria: 'vapes', activo: true, orden: 10, nombre: "RandM Tornado", modelo: "9000 Puffs", precio: 390, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1628532729969-90cb89c74826?q=80&w=800", sabores: [
                { nombre: "Red Bull", disponible: true }, { nombre: "Monster Energy", disponible: true }, { nombre: "Sprite Ice", disponible: true }, { nombre: "Cola Ice", disponible: true }
            ]},
            { id: 11, categoria: 'vapes', activo: true, orden: 11, nombre: "Juul 2", modelo: "Kit", precio: 600, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Virginia Tobacco", disponible: true }, { nombre: "Mint", disponible: true }, { nombre: "Mango", disponible: true }, { nombre: "Cr√®me", disponible: true }
            ]},
            { id: 12, categoria: 'vapes', activo: true, orden: 12, nombre: "Stlth", modelo: "Device", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Frost", disponible: true }, { nombre: "Tundra Berry", disponible: true }, { nombre: "Crisp Apple", disponible: true }, { nombre: "Honeydew", disponible: true }
            ]},
            { id: 13, categoria: 'vapes', activo: true, orden: 13, nombre: "Puff Bar", modelo: "Max Flow", precio: 320, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Cool Mint", disponible: true }, { nombre: "Lush Ice", disponible: true }, { nombre: "Peach Ice", disponible: true }, { nombre: "Pink Lemonade", disponible: true }
            ]},
            { id: 14, categoria: 'vapes', activo: true, orden: 14, nombre: "HQD Cuvie", modelo: "Plus", precio: 290, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: [
                { nombre: "Lemon Tart", disponible: true }, { nombre: "Blueberry", disponible: true }, { nombre: "Strawberry", disponible: true }, { nombre: "Pineapple Ice", disponible: true }
            ]},
            { id: 15, categoria: 'vapes', activo: true, orden: 15, nombre: "Fume Extra", modelo: "1500 Puffs", precio: 270, precioOriginal: 350, enPromocion: true, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: [
                { nombre: "Purple Rain", disponible: true }, { nombre: "Tropical Punch", disponible: true }, { nombre: "Rainbow Candy", disponible: true }, { nombre: "Fresh Vanilla", disponible: true }
            ]},
            { id: 16, categoria: 'vapes', activo: true, orden: 16, nombre: "Hyde Edge", modelo: "Rave", precio: 310, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: [
                { nombre: "Sour Apple Ice", disponible: true }, { nombre: "Neon Rain", disponible: true }, { nombre: "Pina Colada", disponible: true }, { nombre: "Bananas Ice", disponible: true }
            ]},
            { id: 17, categoria: 'vapes', activo: true, orden: 17, nombre: "Kangvape", modelo: "Onee Stick", precio: 330, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: [
                { nombre: "Lush Ice", disponible: true }, { nombre: "Strawberry Banana", disponible: true }, { nombre: "Cool Mint", disponible: true }, { nombre: "Peach Ice", disponible: true }
            ]},
            { id: 18, categoria: 'vapes', activo: true, orden: 18, nombre: "Air Bar", modelo: "Lux", precio: 300, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: [
                { nombre: "Strawberry Kiwi", disponible: true }, { nombre: "Blueberry Ice", disponible: true }, { nombre: "Watermelon", disponible: true }, { nombre: "Mango Bomb", disponible: true }
            ]},
            { id: 19, categoria: 'vapes', activo: true, orden: 19, nombre: "Vaporesso", modelo: "XROS Mini", precio: 480, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: [
                { nombre: "Classic Tobacco", disponible: true }, { nombre: "Mint", disponible: true }, { nombre: "Berry Mix", disponible: true }, { nombre: "Citrus Burst", disponible: true }
            ]},
            { id: 20, categoria: 'vapes', activo: true, orden: 20, nombre: "Caliburn", modelo: "G2", precio: 450, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: [
                { nombre: "Tobacco", disponible: true }, { nombre: "Menthol", disponible: true }, { nombre: "Fruit Punch", disponible: true }, { nombre: "Grape Ice", disponible: true }
            ]},
            { id: 21, categoria: 'vapes', activo: true, orden: 21, nombre: "SMOK Nord", modelo: "4", precio: 420, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1622699292376-788b22e430f7?q=80&w=800", sabores: [
                { nombre: "Apple Peach", disponible: true }, { nombre: "Blueberry Pomegranate", disponible: true }, { nombre: "Strawberry Ice Cream", disponible: true }, { nombre: "Watermelon Lime", disponible: true }
            ]},
            { id: 22, categoria: 'vapes', activo: true, orden: 22, nombre: "Vuse Alto", modelo: "Starter Kit", precio: 380, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1628532729969-90cb89c74826?q=80&w=800", sabores: [
                { nombre: "Golden Tobacco", disponible: true }, { nombre: "Rich Tobacco", disponible: true }, { nombre: "Menthol", disponible: true }, { nombre: "Mint", disponible: true }
            ]},
            { id: 23, categoria: 'vapes', activo: true, orden: 23, nombre: "Blu Bar", modelo: "Disposable", precio: 260, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Carolina Bold", disponible: true }, { nombre: "Classic Tobacco", disponible: true }, { nombre: "Magnificent Menthol", disponible: true }, { nombre: "Polar Mint", disponible: true }
            ]},
            { id: 24, categoria: 'vapes', activo: true, orden: 24, nombre: "Myle Mini", modelo: "Compact", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: [
                { nombre: "Iced Apple Mango", disponible: true }, { nombre: "Cubano", disponible: true }, { nombre: "Tropical Fruit", disponible: true }, { nombre: "Summer Strawberry", disponible: true }
            ]},
            { id: 25, categoria: 'vapes', activo: true, orden: 25, nombre: "Voopoo Drag", modelo: "Nano 2", precio: 490, precioOriginal: 550, enPromocion: true, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: [
                { nombre: "Watermelon Ice", disponible: true }, { nombre: "Grape Ice", disponible: true }, { nombre: "Peach Ice", disponible: true }, { nombre: "Double Apple", disponible: true }
            ]},
            { id: 26, categoria: 'vapes', activo: true, orden: 26, nombre: "Aspire Breeze", modelo: "NXT", precio: 440, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: [
                { nombre: "Vanilla Custard", disponible: true }, { nombre: "Blueberry Cheesecake", disponible: true }, { nombre: "Strawberry Milkshake", disponible: true }, { nombre: "Caramel Tobacco", disponible: true }
            ]},
            { id: 27, categoria: 'vapes', activo: true, orden: 27, nombre: "Novo X", modelo: "SMOK", precio: 400, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: [
                { nombre: "Blue Raspberry Lemonade", disponible: true }, { nombre: "Strawberry Watermelon", disponible: true }, { nombre: "Lemon Mint", disponible: true }, { nombre: "Pineapple Coconut", disponible: true }
            ]},
            { id: 28, categoria: 'vapes', activo: true, orden: 28, nombre: "Suorin Air", modelo: "Pro", precio: 370, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: [
                { nombre: "Mango Tango", disponible: true }, { nombre: "Berry Blast", disponible: true }, { nombre: "Icy Mint", disponible: true }, { nombre: "Peach Passion", disponible: true }
            ]},
            { id: 29, categoria: 'vapes', activo: true, orden: 29, nombre: "Aegis Hero", modelo: "GeekVape", precio: 460, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: [
                { nombre: "Virginia Leaf", disponible: true }, { nombre: "Spearmint", disponible: true }, { nombre: "Cherry Blossom", disponible: true }, { nombre: "Melon Mix", disponible: true }
            ]},
            { id: 30, categoria: 'vapes', activo: true, orden: 30, nombre: "Luxe PM40", modelo: "Vaporesso", precio: 470, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: [
                { nombre: "Kiwi Berry", disponible: true }, { nombre: "Citrus Mix", disponible: true }, { nombre: "Tropical Paradise", disponible: true }, { nombre: "Mint Chocolate", disponible: true }
            ]},
            { id: 31, categoria: 'vapes', activo: true, orden: 31, nombre: "Drag S", modelo: "VooPoo", precio: 520, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1622699292376-788b22e430f7?q=80&w=800", sabores: [
                { nombre: "Strawberry Ice", disponible: true }, { nombre: "Mango Ice", disponible: true }, { nombre: "Blue Razz Lemonade", disponible: true }, { nombre: "Grape Soda", disponible: true }
            ]},
            { id: 32, categoria: 'vapes', activo: true, orden: 32, nombre: "Aegis Boost", modelo: "Pro", precio: 510, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1628532729969-90cb89c74826?q=80&w=800", sabores: [
                { nombre: "Blackberry Lemon", disponible: true }, { nombre: "Pink Lemonade", disponible: true }, { nombre: "Watermelon Mint", disponible: true }, { nombre: "Raspberry Sorbet", disponible: true }
            ]},
            { id: 33, categoria: 'vapes', activo: true, orden: 33, nombre: "Target PM80", modelo: "Vaporesso", precio: 480, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "Honeydew Melon", disponible: true }, { nombre: "Dragon Fruit Lychee", disponible: true }, { nombre: "Passion Fruit", disponible: true }, { nombre: "Guava Ice", disponible: true }
            ]},
            { id: 34, categoria: 'vapes', activo: true, orden: 34, nombre: "Orion Plus", modelo: "Lost Vape", precio: 550, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: [
                { nombre: "Espresso", disponible: true }, { nombre: "Cappuccino", disponible: true }, { nombre: "Irish Cream", disponible: true }, { nombre: "Vanilla Latte", disponible: true }
            ]},
            { id: 35, categoria: 'vapes', activo: true, orden: 35, nombre: "Renova Zero", modelo: "Vaporesso", precio: 390, precioOriginal: 450, enPromocion: true, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: [
                { nombre: "Green Apple", disponible: true }, { nombre: "Cherry Ice", disponible: true }, { nombre: "Pineapple Mango", disponible: true }, { nombre: "Grape Mint", disponible: true }
            ]},
            { id: 36, categoria: 'vapes', activo: true, orden: 36, nombre: "Crown Pod", modelo: "Uwell", precio: 430, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: [
                { nombre: "Sweet Tobacco", disponible: true }, { nombre: "Mint Fusion", disponible: true }, { nombre: "Berry Medley", disponible: true }, { nombre: "Citrus Zest", disponible: true }
            ]},
            { id: 37, categoria: 'vapes', activo: true, orden: 37, nombre: "Nfix", modelo: "SMOK", precio: 340, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: [
                { nombre: "Sour Gummy", disponible: true }, { nombre: "Mixed Berries", disponible: true }, { nombre: "Lemon Tart", disponible: true }, { nombre: "Watermelon Candy", disponible: true }
            ]},
            { id: 38, categoria: 'vapes', activo: true, orden: 38, nombre: "Sceptre", modelo: "Innokin", precio: 500, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: [
                { nombre: "Cucumber Mint", disponible: true }, { nombre: "Rose Lemonade", disponible: true }, { nombre: "Lavender", disponible: true }, { nombre: "Elderflower", disponible: true }
            ]},
            { id: 39, categoria: 'vapes', activo: true, orden: 39, nombre: "Wenax K1", modelo: "GeekVape", precio: 360, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: [
                { nombre: "Strawberry Cream", disponible: true }, { nombre: "Banana Pudding", disponible: true }, { nombre: "Cookies & Cream", disponible: true }, { nombre: "Hazelnut", disponible: true }
            ]},
            { id: 40, categoria: 'vapes', activo: true, orden: 40, nombre: "Vilter", modelo: "Uwell", precio: 410, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: [
                { nombre: "Blue Slush", disponible: true }, { nombre: "Cherry Cola", disponible: true }, { nombre: "Lemon Sherbet", disponible: true }, { nombre: "Rainbow Ice", disponible: true }
            ]},
            { id: 41, categoria: 'vapes', activo: true, orden: 41, nombre: "Osmall", modelo: "Vaporesso", precio: 320, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1622699292376-788b22e430f7?q=80&w=800", sabores: [
                { nombre: "Aloe Vera", disponible: true }, { nombre: "Green Tea", disponible: true }, { nombre: "Jasmine", disponible: true }, { nombre: "Peach Blossom", disponible: true }
            ]},
            { id: 42, categoria: 'vapes', activo: true, orden: 42, nombre: "Minifit", modelo: "Justfog", precio: 290, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1628532729969-90cb89c74826?q=80&w=800", sabores: [
                { nombre: "Apple Mint", disponible: true }, { nombre: "Berry Mix", disponible: true }, { nombre: "Citrus Punch", disponible: true }, { nombre: "Tropical Fusion", disponible: true }
            ]},
            { id: 43, categoria: 'vapes', activo: true, orden: 43, nombre: "Nunchaku 2", modelo: "Uwell", precio: 530, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1563821010-859a53855a84?q=80&w=800", sabores: [
                { nombre: "American Tobacco", disponible: true }, { nombre: "Cuban Cigar", disponible: true }, { nombre: "English Blend", disponible: true }, { nombre: "Turkish Delight", disponible: true }
            ]},
            { id: 44, categoria: 'vapes', activo: true, orden: 44, nombre: "Doric 20", modelo: "VooPoo", precio: 350, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1534119339343-73db60d4b64a?q=80&w=800", sabores: [
                { nombre: "Bubble Gum", disponible: true }, { nombre: "Cotton Candy", disponible: true }, { nombre: "Gummy Bear", disponible: true }, { nombre: "Jelly Bean", disponible: true }
            ]},
            { id: 45, categoria: 'vapes', activo: true, orden: 45, nombre: "Zero 2", modelo: "Vaporesso", precio: 420, precioOriginal: 480, enPromocion: true, img: "https://images.unsplash.com/photo-1574920807753-333e248b9432?q=80&w=800", sabores: [
                { nombre: "Acai Berry", disponible: true }, { nombre: "Pomegranate", disponible: true }, { nombre: "Cranberry", disponible: true }, { nombre: "Blood Orange", disponible: true }
            ]},
            { id: 46, categoria: 'vapes', activo: true, orden: 46, nombre: "Vinci Air", modelo: "VooPoo", precio: 460, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1579222530327-14227928d1d0?q=80&w=800", sabores: [
                { nombre: "Lemonade Ice", disponible: true }, { nombre: "Fruit Punch", disponible: true }, { nombre: "Energy Drink", disponible: true }, { nombre: "Ice Tea", disponible: true }
            ]},
            { id: 47, categoria: 'vapes', activo: true, orden: 47, nombre: "Wenax C1", modelo: "GeekVape", precio: 370, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1604170422479-7df97b7b9e07?q=80&w=800", sabores: [
                { nombre: "Blackcurrant", disponible: true }, { nombre: "Passion Mango", disponible: true }, { nombre: "Pear Ice", disponible: true }, { nombre: "Raspberry Lemon", disponible: true }
            ]},
            { id: 48, categoria: 'vapes', activo: true, orden: 48, nombre: "Exceed Grip", modelo: "Joyetech", precio: 390, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1565551352631-b0e9db63a436?q=80&w=800", sabores: [
                { nombre: "Cinnamon Roll", disponible: true }, { nombre: "Maple Syrup", disponible: true }, { nombre: "Toffee", disponible: true }, { nombre: "Butterscotch", disponible: true }
            ]},
            { id: 49, categoria: 'vapes', activo: true, orden: 49, nombre: "Podin", modelo: "Innokin", precio: 340, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1598960243431-7b052e07971f?q=80&w=800", sabores: [
                { nombre: "Mojito", disponible: true }, { nombre: "Pi√±a Colada", disponible: true }, { nombre: "Margarita", disponible: true }, { nombre: "Daiquiri", disponible: true }
            ]},
            { id: 50, categoria: 'vapes', activo: true, orden: 50, nombre: "Vinci Q", modelo: "VooPoo", precio: 380, precioOriginal: 0, enPromocion: false, img: "https://images.unsplash.com/photo-1620215707769-633096245037?q=80&w=800", sabores: [
                { nombre: "Champagne", disponible: true }, { nombre: "Red Wine", disponible: true }, { nombre: "White Wine", disponible: true }, { nombre: "Sangria", disponible: true }
            ]}
        ];

        let productoActual = null;
        let carrito = JSON.parse(localStorage.getItem('vp_carrito')) || [];
        let mensajeIndex = 0;
        let tickerInterval;

        // Cargar carrito del localStorage y renderizar
        function cargarCarritoDelStorage() {
            const stored = localStorage.getItem('vp_carrito');
            if (stored) {
                try {
                    carrito = JSON.parse(stored);
                    actualizarBadgeCarrito();
                    renderFloatingCart();
                } catch (e) {
                    console.log('Error cargando carrito:', e);
                }
            }
        }

        // Si la vista del carrito est√° abierta (seccion-grid), forzar re-render
        function syncCarritoViewIfOpen() {
            try {
                const gridEl = document.getElementById('seccion-grid');
                if (gridEl && gridEl.style.display === 'block') {
                    // Solo actualizar si ya estamos en la vista del carrito
                    const contenedor = document.getElementById('grid-productos');
                    if (contenedor && contenedor.querySelector('.carrito-header')) {
                        abrirCarrito();
                    }
                }
            } catch (e) {
                console.warn('syncCarritoViewIfOpen error', e);
            }
        }

        function iniciarTicker() {
            mostrarMensajeTicker(mensajeIndex);
            tickerInterval = setInterval(() => { cambiarMensaje(1); }, TIEMPO_ROTACION);
        }
        
        let tickerPausado = false;
        
        function toggleTickerPause() {
            tickerPausado = !tickerPausado;
            const display = document.getElementById('ticker-display');
            
            if (tickerPausado) {
                clearInterval(tickerInterval);
                display.style.textDecoration = 'underline';
                display.style.cursor = 'pointer';
            } else {
                tickerInterval = setInterval(() => { cambiarMensaje(1); }, TIEMPO_ROTACION);
                display.style.textDecoration = 'none';
            }
        }
        
        function mostrarMensajeTicker(index) {
            const display = document.getElementById('ticker-display');
            display.style.opacity = 0;
            display.style.transform = "translateY(5px)";
            setTimeout(() => {
                let msg = (Array.isArray(MENSAJES_TICKER) && MENSAJES_TICKER.length) ? MENSAJES_TICKER[index] || MENSAJES_TICKER[0] : '';
                display.innerHTML = msg;
                display.style.opacity = 1;
                display.style.transform = "translateY(0)";
                
                // Agregar event listener al tel√©fono si existe
                const phoneSpan = display.querySelector('.ticker-phone');
                if (phoneSpan) {
                    phoneSpan.onclick = function(e) {
                        e.stopPropagation();
                        const numero = phoneSpan.textContent.trim().replace(/\s/g, '');
                        window.open(`https://wa.me/52${numero}`, '_blank');
                    };
                }
            }, 300);
        }
        function cambiarMensaje(dir) {
            if (tickerPausado) return; // No cambiar si est√° pausado
            clearInterval(tickerInterval);
            tickerInterval = setInterval(() => { cambiarMensaje(1); }, TIEMPO_ROTACION);
            mensajeIndex += dir;
            if (mensajeIndex >= MENSAJES_TICKER.length) mensajeIndex = 0;
            if (mensajeIndex < 0) mensajeIndex = MENSAJES_TICKER.length - 1;
            mostrarMensajeTicker(mensajeIndex);
        }

        function mostrarToast(mensaje) {
            const toast = document.getElementById('toast-notification');
            const msg = document.getElementById('toast-message');
            msg.innerText = mensaje;
            // Asegurar que el estilo inline no impida que la clase muestre el toast
            toast.style.display = '';
            toast.className = "toast show";
            // Ocultar despu√©s de 3s y limpiar display inline
            setTimeout(() => { 
                toast.className = toast.className.replace("show", ""); 
                // Espera la animaci√≥n y luego oculta por completo
                setTimeout(() => { toast.style.display = 'none'; }, 250);
            }, 3000);
        }

        // Prompt sencillo para capturar el correo antes de enviar la factura
        function abrirPromptCorreo(action) {
            _pendingAction = action || null;
            const prompt = document.getElementById('email-prompt');
            const input = document.getElementById('email-prompt-input');
            if (!prompt || !input) {
                mostrarAlertaModal('No se pudo abrir el formulario de correo.');
                return;
            }
            prompt.style.display = 'flex';
            setTimeout(() => { try { input.focus(); } catch (e) {} }, 80);
        }

        function cerrarPromptCorreo() {
            const prompt = document.getElementById('email-prompt');
            if (prompt) prompt.style.display = 'none';
            _pendingAction = null;
        }

        async function confirmarPromptCorreo() {
            const input = document.getElementById('email-prompt-input');
            const correo = (input ? input.value : '').trim();

            if (!correo || !correo.includes('@') || !correo.includes('.')) {
                mostrarAlertaModal('Ingresa un correo v√°lido para enviar la factura.');
                return;
            }

            const now = Date.now();
            if (now < _emailCooldownUntil) {
                const wait = Math.ceil((_emailCooldownUntil - now) / 1000);
                mostrarToast(`Espera ${wait}s para volver a enviar la factura.`);
                return;
            }

            const action = _pendingAction;
            cerrarPromptCorreo();
            await procesarAccionConCorreo(correo, action);
        }

        // Muestra una confirmaci√≥n visual destacada al agregar producto
        let _successTimeout = null;
        function mostrarConfirmacionAgregado(mensaje = 'Agregado exitosamente') {
            try {
                const box = document.getElementById('success-alert');
                const txt = document.getElementById('success-text');
                if (!box || !txt) return;
                txt.innerText = mensaje;
                box.classList.remove('show');
                // Force reflow to restart animation
                void box.offsetWidth;
                box.classList.add('show');
                box.setAttribute('aria-hidden','false');
                // Limpiar timeout anterior
                if (_successTimeout) clearTimeout(_successTimeout);
                _successTimeout = setTimeout(() => {
                    box.classList.remove('show');
                    box.setAttribute('aria-hidden','true');
                }, 2000);
            } catch (e) { console.warn('mostrarConfirmacionAgregado error', e); }
        }
        
        function mostrarAlertaModal(msg) {
             document.getElementById('alert-title').innerText = "Atenci√≥n";
             document.getElementById('alert-message').innerText = msg;
             document.getElementById('custom-alert').style.display = 'flex';
        }
        
        function cerrarAlerta() {
             document.getElementById('custom-alert').style.display = 'none';
        }

        function irArriba() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        
        window.onscroll = function() {
            const btn = document.getElementById('btn-back-to-top');
            if (!AJUSTES_RAPIDOS.mostrarBackToTop) {
                if (btn) btn.style.display = 'none';
                return;
            }
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
            
            // Control del bot√≥n COMPRAR YA - detenerlo antes del footer
            const btnOrder = document.getElementById('btn-order-now-floating');
            if (btnOrder && btnOrder.style.display !== 'none') {
                const footer = document.querySelector('footer');
                if (footer) {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const footerTop = footer.offsetTop;
                    const btnHeight = btnOrder.offsetHeight;
                    const btnBottomMargin = 20;
                    
                    // Calcular cu√°ndo el bot√≥n alcanzar√≠a el footer
                    const stopPoint = footerTop - windowHeight + btnBottomMargin + btnHeight;
                    
                    if (scrollTop >= stopPoint) {
                        // Cambiar a absolute y posicionarlo justo antes del footer
                        btnOrder.style.position = 'absolute';
                        btnOrder.style.bottom = 'auto';
                        btnOrder.style.top = (footerTop - btnHeight - btnBottomMargin - 80) + 'px';
                    } else {
                        // Mantener fixed flotando
                        btnOrder.style.position = 'fixed';
                        btnOrder.style.bottom = '20px';
                        btnOrder.style.top = 'auto';
                    }
                }
            }
        };

        function actualizarBadgeCarrito() {
            const badge = document.getElementById('carrito-count');
            const totalQty = carrito.reduce((sum, it) => sum + (parseInt(it.cantidad, 10) || 0), 0);
            badge.innerText = totalQty;
            badge.style.transform = "scale(1.3)";
            setTimeout(() => badge.style.transform = "scale(1)", 200);
            // actualizar badge flotante
            const waBadge = document.getElementById('whatsapp-badge');
            if (waBadge) waBadge.innerText = totalQty;
        }
        
        function guardarEnCarrito(mostrarConfirmacion = true) {
            if (!productoActual) return;
            
            let cantidad = parseInt(document.getElementById('cantidad-seleccionada').value);
            let variante = "Est√°ndar";
            let inputManual = document.getElementById('input-variante-manual');
            let valorChip = document.getElementById('variante-seleccionada-valor') ? document.getElementById('variante-seleccionada-valor').value : "";
            
            if (inputManual && inputManual.value) variante = inputManual.value;
            else if (valorChip) variante = valorChip;
            
            if (productoActual.sabores && productoActual.sabores.length > 0 && !valorChip) {
                mostrarAlertaModal("‚ö†Ô∏è Por favor selecciona un sabor o variante.");
                return;
            }

            // Buscar por producto + variante para permitir m√∫ltiples variantes como items separados
            const existeIndex = carrito.findIndex(item => item.id === productoActual.id && item.variante === variante);
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');

            if (existeIndex === -1) {
                carrito.push({
                    id: productoActual.id,
                    cantidad: cantidad || 1,
                    variante: variante,
                    nombre: productoActual.nombre,
                    precio: productoActual.precio,
                    img: productoActual.img
                });

                // Actualizar bot√≥n a "Quitar"
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.classList.remove('boton-pedir');
                botonAgregar.classList.add('btn-quitar-carrito');

                if (mostrarConfirmacion) {
                    mostrarToast('¬°Agregado al carrito!');
                    // Desde modal: mostrar tambi√©n la confirmaci√≥n animada verde para que sea visible
                    mostrarConfirmacionAgregado('Agregado exitosamente');
                }

            } else {
                if (!mostrarConfirmacion) {
                    // Al quitar desde el modal, eliminamos todos los items del mismo producto
                    carrito = carrito.filter(item => item.id !== productoActual.id);
                    // Actualizar bot√≥n a "Agregar"
                    botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                    botonAgregar.classList.remove('btn-quitar-carrito');
                    botonAgregar.classList.add('boton-pedir');
                    mostrarToast('Eliminado del carrito');
                } else {
                    carrito[existeIndex].cantidad = cantidad || carrito[existeIndex].cantidad;
                    carrito[existeIndex].variante = variante;
                    mostrarToast('Carrito actualizado');
                }
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mantener la vista del carrito sincronizada si est√° abierta
            syncCarritoViewIfOpen();
        }

        function handleCarritoToggle() {
            if (!productoActual) return;
            
            // Verificar si el producto ya est√° en el carrito
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            
            if (enCarrito) {
                // Eliminar del carrito
                carrito = carrito.filter(item => item.id !== productoActual.id);
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                syncCarritoViewIfOpen();
                
                mostrarToast('Eliminado del carrito');
                
                // Cerrar modal autom√°ticamente
                cerrarModal();
                
                // Si el carrito qued√≥ vac√≠o, recargar la p√°gina
                if (carrito.length === 0) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    return;
                }
            } else {
                // Agregar al carrito (no cerrar modal para seguir viendo productos)
                guardarEnCarrito();
                mostrarToast('‚úì Agregado al carrito');
            }
        }

        // Funci√≥n para actualizar el bot√≥n del modal basado en el estado del carrito
        function actualizarBotonModal() {
            if (!productoActual) return;
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');
            if (!botonAgregar) return;
            
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            
            if (enCarrito) {
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.classList.remove('boton-pedir');
                botonAgregar.classList.add('btn-quitar-carrito');
            } else {
                botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                botonAgregar.classList.remove('btn-quitar-carrito');
                botonAgregar.classList.add('boton-pedir');
            }
        }

        function abrirCarrito() {
            if(carrito.length === 0) {
                mostrarAlertaModal("Tu carrito est√° vac√≠o. ¬°Agrega productos!");
                return;
            }
            document.getElementById('seccion-categorias').style.display = 'none';
            document.getElementById('seccion-grid').style.display = 'block';
            
            // Mostrar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) {
                btnOrderNow.style.display = 'block';
            }
            
            const contenedor = document.getElementById('grid-productos');
            // CORRECCI√ìN: grid-column: 1 / -1para que el t√≠tulo ocupe todo el ancho
            contenedor.innerHTML = `<div class="carrito-header" style="grid-column: 1 / -1;">
                <h2 class=\"titulo-seccion-grid\">Carrito (${carrito.length})</h2>
            </div>`;
            
            carrito.forEach(item => {
                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-producto';
                tarjeta.innerHTML = `
                    <div class="img-wrapper"><img src="${item.img}" alt="${item.nombre}" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Imagen'"></div>
                    <div class="info-card">
                        <h3>${item.nombre}</h3>
                        <p style="color:#aaa; font-size:0.8rem; margin-bottom:5px;">${item.variante}</p>
                        <div style="display:flex; align-items:center; gap:12px; margin-top:6px;">
                            <div style="color:#bbb; font-size:0.9rem;">Precio unitario: ${formatearDinero(item.precio)}</div>
                            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${item.id}, '${encodeURIComponent(item.variante)}', -1)"><i class="ph ph-minus"></i></button>
                                <div style="min-width:28px; text-align:center; color:#fff; font-weight:700;">${item.cantidad}</div>
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${item.id}, '${encodeURIComponent(item.variante)}', 1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <p class="precio-card" style="margin-top:8px;">Subtotal: ${formatearDinero(item.precio * item.cantidad)}</p>
                    </div>
                `;
                tarjeta.onclick = function() { abrirModal(item.id); };
                contenedor.appendChild(tarjeta);
            });
        }

        function filtrarBusqueda() {
            const input = document.getElementById('input-busqueda');
            const filtro = input.value.toLowerCase();
            const resultadosDiv = document.getElementById('resultados-busqueda');
            resultadosDiv.innerHTML = '';
            
            if (filtro.length < 1) { 
                resultadosDiv.style.display = 'none';
                return;
            }

            const coincidencias = listaProductos.filter(prod => {
                if (!prod.activo) return false;
                if (!prod.nombre.toLowerCase().includes(filtro) && !prod.modelo.toLowerCase().includes(filtro)) return false;
                const seccionCategoria = CONFIG_SECCIONES.find(s => s.id === prod.categoria);
                if (!seccionCategoria) return false;
                return seccionCategoria.visible === true && seccionCategoria.disponible === true;
            });

            if (coincidencias.length > 0) {
                resultadosDiv.style.display = 'block';
                coincidencias.forEach(prod => {
                    const item = document.createElement('div');
                    item.className = 'resultado-item';
                    let ofertaTxt = prod.enPromocion ? '<span class="tag-oferta-busqueda">¬°OFERTA!</span>' : '';
                        item.innerHTML = `<img src="${prod.img}" style="width:40px; height:40px; object-fit:cover; border-radius:5px; margin-right:10px;" onerror="this.onerror=null;this.src='https://via.placeholder.com/80?text=Imagen'"/><div><span class="nombre-busqueda">${prod.nombre}</span><span class="modelo-busqueda" style="display:block; font-size:0.7rem;">${prod.modelo}</span></div>${ofertaTxt}`;
                    item.onclick = function() {
                        abrirModal(prod.id);
                        input.value = '';
                        resultadosDiv.style.display = 'none';
                    };
                    resultadosDiv.appendChild(item);
                });
            } else {
                resultadosDiv.style.display = 'none';
            }
        }

        function verificarEnter(event) {
            if (event.key === "Enter") {
                const texto = document.getElementById('input-busqueda').value.toLowerCase();
                if (texto.trim() === "") return;
                
                const resultados = listaProductos.filter(prod => {
                    if (!prod.activo) return false;
                    if (!prod.nombre.toLowerCase().includes(texto) && !prod.modelo.toLowerCase().includes(texto)) return false;
                    const seccionCategoria = CONFIG_SECCIONES.find(s => s.id === prod.categoria);
                    if (!seccionCategoria) return false;
                    return seccionCategoria.visible === true && seccionCategoria.disponible === true;
                });

                document.getElementById('seccion-categorias').style.display = 'none';
                document.getElementById('seccion-grid').style.display = 'block';
                const contenedor = document.getElementById('grid-productos');
                contenedor.innerHTML = "";
                
                if(resultados.length === 0) {
                    contenedor.innerHTML = `<p style="text-align:center; width:100%; color:#888;">No se encontraron productos.</p>`;
                } else {
                    renderizarGrid(resultados, contenedor, false);
                }
                
                document.getElementById('resultados-busqueda').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        document.addEventListener('click', function(event) {
            const buscador = document.querySelector('.buscador-container');
            if (!buscador.contains(event.target)) {
                document.getElementById('resultados-busqueda').style.display = 'none';
            }
        });

        function renderizarMenuInicio() {
            const cont = document.getElementById('contenedor-categorias-dinamico');
            cont.innerHTML = '';
            
            // Crear la tarjeta de vapes principal
            const div = document.createElement('div');
            div.className = 'tarjeta-vape-principal';
            div.setAttribute('data-aos', 'fade-up');
            div.onclick = () => mostrarCatalogoCompleto();
            
            div.innerHTML = `
                <div class="tarjeta-vape-imagen">
                    <img src="Imagenes/vapes.jpeg" alt="Cat√°logo Waka Vapes" onerror="this.onerror=null;this.src='https://via.placeholder.com/450x400?text=Vapes'">
                </div>
                <div class="tarjeta-vape-titulo">
                    <h2>!VAPES MAYOREO; <i class="ph ph-arrow-right"></i></h2>
                </div>
            `;
            cont.appendChild(div);
            
            // FIX CR√çTICO: Refrescar AOS despu√©s de crear los elementos para que se vean
            setTimeout(() => AOS.refresh(), 200);
        }

        function cargarCatalogo(filtro) {
            document.getElementById('seccion-categorias').style.display = 'none';
            document.getElementById('seccion-grid').style.display = 'block';
            
            // Ocultar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) btnOrderNow.style.display = 'none';
            
            setTimeout(() => AOS.refresh(), 100);
            const contenedor = document.getElementById('grid-productos');
            // CORRECCI√ìN: Asegurar que el t√≠tulo de categor√≠a ocupe todo el ancho
            contenedor.innerHTML = `<h2 style="width:100%; text-align:center; color:#D4AF37; margin-bottom:20px; font-size:1.5rem; grid-column: 1 / -1;">${filtro.toUpperCase()}</h2>`;
            
            let prods = [];
            if(filtro === 'ofertas') {
                // Filtrar ofertas solo de categor√≠as visibles y disponibles (no pr√≥ximamente)
                prods = listaProductos.filter(p => {
                    if (!p.activo || !p.enPromocion) return false;
                    const seccionCategoria = CONFIG_SECCIONES.find(s => s.id === p.categoria);
                    if (!seccionCategoria) return false;
                    return seccionCategoria.visible === true && seccionCategoria.disponible === true;
                });
            }
            else prods = listaProductos.filter(p => p.activo && p.categoria === filtro);
            
            // ORDENAMIENTO POR PROPIEDAD "orden"
            prods.sort((a,b) => a.orden - b.orden);
            
            renderizarGrid(prods, contenedor, false); // false para no borrar el t√≠tulo
            window.scrollTo(0,0);
        }

        function renderizarGrid(lista, contenedor, limpiar = true) {
            if (limpiar) contenedor.innerHTML = "";
            if (lista.length === 0) { contenedor.innerHTML += `<p style="width:100%; text-align:center; color:#888; margin-top:50px; grid-column: 1 / -1;">No hay productos disponibles.</p>`; return; }
            lista.forEach((prod, idx) => {
                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta-producto';
                tarjeta.setAttribute('data-aos', 'fade-up');
                tarjeta.setAttribute('data-aos-delay', idx * 50);
                tarjeta.onclick = () => abrirModal(prod.id);
                let etiq = prod.enPromocion ? `<div class="etiqueta-oferta">OFERTA</div>` : '';
                let prec = prod.enPromocion ? `<div class="bloque-precios"><span class="precio-tachado">${formatearDinero(prod.precioOriginal)}</span><span class="precio-card precio-rojo">${formatearDinero(prod.precio)}</span></div>` : `<div class="bloque-precios"><span class="precio-card">${formatearDinero(prod.precio)}</span></div>`;
                // Controles r√°pidos: siempre mostrar solo el bot√≥n de carrito
                let controlesRapidos = '';
                const varianteDef = (prod.modelo && prod.modelo.length>0) ? prod.modelo : 'Est√°ndar';
                const enCarritoItem = carrito.find(it => it.id === prod.id && it.variante === varianteDef);
                // Siempre mostrar icono de carrito (con check si ya est√° agregado)
                if (enCarritoItem) {
                    controlesRapidos = `<button class=\"btn-agregar-card agregado\" onclick=\"event.stopPropagation(); abrirModal(${prod.id})\" title=\"En carrito\"><i class=\"ph ph-check-circle\"></i></button>`;
                } else {
                    controlesRapidos = `<button class=\"btn-agregar-card\" onclick=\"event.stopPropagation(); agregarAlCarritoRapido(${prod.id})\" title=\"Agregar\"><i class=\"ph ph-shopping-cart\"></i></button>`;
                }

                tarjeta.innerHTML = `<div class="img-wrapper">${etiq}<img src="${prod.img}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Imagen'"></div><div class="info-card"><h3>${prod.nombre}</h3>${prec}<div style="display:flex; gap:8px; justify-content:center; align-items:center; margin-top:10px;">${controlesRapidos}<span class="texto-ver-detalles">Ver Detalles</span></div></div>`;
                contenedor.appendChild(tarjeta);
            });
        }

        // Pedir directo desde tarjeta de producto: a√±ade al carrito y abre el panel/enlace
        function pedirProductoDirecto(idProducto) {
            const producto = listaProductos.find(p => p.id === idProducto);
            if (!producto) return;
            // Variante por defecto
            let variante = producto.modelo || 'Est√°ndar';
            if (producto.sabores && producto.sabores.length > 0) variante = producto.sabores[0].nombre;
            // Buscar item existente por id+variante
            const idx = carrito.findIndex(it => it.id === producto.id && it.variante === variante);
            if (idx === -1) {
                carrito.push({ id: producto.id, cantidad: 1, variante, nombre: producto.nombre, precio: producto.precio, img: producto.img });
            } else {
                carrito[idx].cantidad = Number(carrito[idx].cantidad) + 1;
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mostrar toast peque√±o y discreto (no modal, as√≠ que evitar la alerta animada)
            mostrarToast('‚úì Agregado al carrito');
            syncCarritoViewIfOpen();
            openFloatingCart();
        }

        // Agregar al carrito desde tarjeta de producto
        function agregarAlCarritoRapido(idProducto) {
            const producto = listaProductos.find(p => p.id === idProducto);
            if (!producto) return;
            // Si el producto tiene variantes/sabores, tomar la primera variante disponible por defecto
            let variante = producto.modelo || 'Est√°ndar';
            if (producto.sabores && producto.sabores.length > 0) {
                const primera = producto.sabores.find(s => s.disponible !== false) || producto.sabores[0];
                if (primera && primera.nombre) variante = primera.nombre;
            }
            const idx = carrito.findIndex(it => it.id === producto.id && it.variante === variante);
            if (idx === -1) {
                carrito.push({ id: producto.id, cantidad: 1, variante, nombre: producto.nombre, precio: producto.precio, img: producto.img });
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                // Desde tarjeta (sin modal): mostrar toast peque√±o y discreto
                mostrarToast('‚úì Agregado al carrito');
                const wb = document.getElementById('whatsapp-badge');
                if (wb) { wb.classList.add('pulse'); setTimeout(() => wb.classList.remove('pulse'), 900); }
                syncCarritoViewIfOpen();
            } else {
                carrito[idx].cantidad = Number(carrito[idx].cantidad) + 1;
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                syncCarritoViewIfOpen();
                // Actualizaci√≥n: mostrar solo toast para no distraer
                mostrarToast('‚úì Cantidad actualizada');
            }
        }

        // Funci√≥n para mostrar el cat√°logo completo de vapes
        function mostrarCatalogoCompleto() {
            cargarCatalogo('vapes');
        }

        function irAlInicio() {
            document.getElementById('seccion-categorias').style.display = 'block';
            document.getElementById('seccion-grid').style.display = 'none';
            document.getElementById('input-busqueda').value = '';
            
            // Ocultar bot√≥n flotante de hacer pedido
            const btnOrderNow = document.getElementById('btn-order-now-floating');
            if (btnOrderNow) btnOrderNow.style.display = 'none';
            
            window.scrollTo(0,0);
        }

        // --- MODAL ---
        function abrirModal(idProducto) {
            productoActual = listaProductos.find(p => p.id === idProducto);
            if(!productoActual) return;

            document.getElementById('modal-img').src = productoActual.img;
            document.getElementById('modal-titulo-producto').innerText = productoActual.nombre;
            document.getElementById('modal-modelo-producto').innerText = productoActual.modelo;
            
            const contPrecio = document.getElementById('contenedor-precio-modal');
            contPrecio.innerHTML = productoActual.enPromocion ? 
                `<span class="precio-tachado-modal">${formatearDinero(productoActual.precioOriginal)}</span><span class="precio-modal precio-rojo">${formatearDinero(productoActual.precio)}</span>` : 
                `<span class="precio-modal">${formatearDinero(productoActual.precio)}</span>`;

            document.getElementById('cantidad-seleccionada').value = 1;
            document.getElementById('total-precio').innerText = formatearDinero(productoActual.precio);

            // Mostrar y cargar valor de orden editable
            const inputOrden = document.getElementById('input-orden-modal');
            if (inputOrden) {
                inputOrden.value = (productoActual.orden !== undefined) ? productoActual.orden : '';
                inputOrden.onchange = function() { actualizarOrdenProductoActual(Number(this.value)); };
            }

            // Variantes
            const contVariantes = document.getElementById('contenedor-variantes');
            contVariantes.innerHTML = '';
            if (document.getElementById('variante-seleccionada-valor')) document.getElementById('variante-seleccionada-valor').value = ""; 

            if (productoActual.sabores && productoActual.sabores.length > 0) {
                document.getElementById('titulo-variantes').innerText = "Selecciona Sabor:";
                const grid = document.createElement('div'); grid.className = 'grid-variantes';
                const hiddenInput = document.getElementById('variante-seleccionada-valor');

                productoActual.sabores.forEach(sabor => {
                    const btn = document.createElement('button');
                    btn.className = `chip-variante ${sabor.disponible ? '' : 'agotado'}`;
                    btn.innerText = sabor.nombre;
                    
                    // Marcar si ya estaba seleccionado en carrito
                    const itemEnCarrito = carrito.find(i => i.id === productoActual.id);
                    if(itemEnCarrito && itemEnCarrito.variante === sabor.nombre) {
                        btn.classList.add('activo');
                        hiddenInput.value = sabor.nombre;
                    }

                    if (sabor.disponible) {
                        btn.onclick = function() {
                            document.querySelectorAll('.chip-variante').forEach(b => b.classList.remove('activo'));
                            btn.classList.add('activo');
                            hiddenInput.value = sabor.nombre;
                        };
                    }
                    grid.appendChild(btn);
                });
                contVariantes.appendChild(grid);
            } else {
                document.getElementById('titulo-variantes').innerText = "Especificaci√≥n:";
                // Recuperar valor
                const itemEnCarrito = carrito.find(i => i.id === productoActual.id);
                let val = itemEnCarrito ? itemEnCarrito.variante : productoActual.modelo;
                contVariantes.innerHTML = `<input type="text" id="input-variante-manual" value="${val}" readonly class="input-modal-texto">`;
            }

            // Actualizar bot√≥n de agregar/quitar seg√∫n estado en carrito
            const enCarrito = carrito.some(item => item.id === productoActual.id);
            const botonAgregar = document.getElementById('btn-agregar-carrito-modal');
            
            if (enCarrito) {
                botonAgregar.innerHTML = '<i class="ph ph-trash"></i> Quitar del Carrito';
                botonAgregar.classList.remove('boton-pedir');
                botonAgregar.classList.add('btn-quitar-carrito');
            } else {
                botonAgregar.innerHTML = '<i class="ph ph-shopping-cart"></i> Agregar al carrito';
                botonAgregar.classList.remove('btn-quitar-carrito');
                botonAgregar.classList.add('boton-pedir');
            }

            // Detectar si el producto es de "sobrepedido" y actualizar bot√≥n de WhatsApp
            const esSobrePedido = productoActual.categoria === 'sobrepedido';
            const btnWhatsApp = document.getElementById('btn-whatsapp-modal');
            const advertenciaSobrePedido = document.getElementById('advertencia-sobre-pedido-modal');
            
            if (esSobrePedido) {
                btnWhatsApp.innerHTML = '<i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Hacer Sobre Pedido</span>';
                btnWhatsApp.style.background = 'linear-gradient(135deg, #9ca3af, #6b7280)';
                advertenciaSobrePedido.style.display = 'block';
            } else {
                btnWhatsApp.innerHTML = '<i class="ph ph-whatsapp-logo" style="margin-right:8px;"></i><span>Comprar ya</span>';
                btnWhatsApp.style.background = 'linear-gradient(180deg, #2ac05f 0%, #25d366 60%)';
                advertenciaSobrePedido.style.display = 'none';
            }

            // Recomendados
            const recomendados = listaProductos.filter(p => p.categoria === productoActual.categoria && p.id !== productoActual.id).slice(0, 5);
            const gridRecom = document.getElementById('grid-recomendados');
            gridRecom.innerHTML = '';
            recomendados.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'card-recomendada';
                card.onclick = function() { window.scrollTo({ top: 0, behavior: 'smooth' }); abrirModal(rec.id); };
                card.innerHTML = `<img src="${rec.img}" onerror="this.onerror=null;this.src='https://via.placeholder.com/150?text=Imagen'"><div><p class="rec-nombre">${rec.nombre}</p><p class="rec-precio">${formatearDinero(rec.precio)}</p></div>`;
                gridRecom.appendChild(card);
            });
            // A√±adir flechas flotantes para scroll t√°ctil en recomendaciones
            const wrapper = document.querySelector('.grid-recomendados-wrapper');
            // Eliminar flechas previas si existen
            ['.recom-arrow-left','.recom-arrow-right'].forEach(s => { const e = wrapper.querySelector(s); if (e) e.remove(); });
            const left = document.createElement('button');
            left.className = 'recom-arrow recom-arrow-left';
            left.innerHTML = '<i class="ph ph-caret-left"></i>';
            left.onclick = () => gridRecom.scrollBy({ left: -220, behavior: 'smooth' });
            const right = document.createElement('button');
            right.className = 'recom-arrow recom-arrow-right';
            right.innerHTML = '<i class="ph ph-caret-right"></i>';
            right.onclick = () => gridRecom.scrollBy({ left: 220, behavior: 'smooth' });
            wrapper.appendChild(left); wrapper.appendChild(right);

            const modalEl = document.getElementById('modal-pedido');
            modalEl.style.display = 'flex';
            document.body.classList.add('modal-open');
            // Asegurar que el modal est√° completamente visible
            setTimeout(() => {
                const modalBody = modalEl.querySelector('.modal-body');
                if (modalBody) { modalBody.scrollTop = 0; }
                const closeBtn = modalEl.querySelector('.cerrar-modal');
                if (closeBtn) { closeBtn.focus(); }
                // Asegurar que el modal est√° visible sin scroll
                modalEl.style.position = 'fixed';
                modalEl.style.top = '0';
                modalEl.style.left = '0';
            }, 50);
            // attach keyboard handlers for accessibility (ESC to close, focus trap)
            attachModalKeyHandlers();
        }

        function actualizarOrdenProductoActual(nuevoOrden) {
            if (!productoActual) return;
            if (isNaN(nuevoOrden)) { mostrarToast('Orden inv√°lido'); return; }
            productoActual.orden = Number(nuevoOrden);
            const idx = listaProductos.findIndex(p => p.id === productoActual.id);
            if (idx !== -1) listaProductos[idx].orden = productoActual.orden;
            // Reordenar vistas: men√∫ de inicio y grid actual si hay uno
            renderizarMenuInicio();
            if (document.getElementById('seccion-grid').style.display === 'block') {
                // Intentar deducir el filtro actual a partir del t√≠tulo en grid
                const tituloEl = document.querySelector('#grid-productos h2');
                    if (tituloEl) {
                    const filtro = tituloEl.innerText.toLowerCase();
                    cargarCatalogo(filtro, true);
                }
            }
            mostrarToast('Orden actualizado');
        }
        
        function scrollRecomendados(direction) {
            const container = document.getElementById('grid-recomendados');
            container.scrollBy({ left: direction * 200, behavior: 'smooth' });
        }

        // --- UTILS ---
        function cerrarModal() { document.getElementById('modal-pedido').style.display = 'none'; document.body.classList.remove('modal-open'); }

        // --- Accessibility: focus trap and ESC handler for modal ---
        let _lastFocusedBeforeModal = null;
        function attachModalKeyHandlers() {
            const modal = document.getElementById('modal-pedido');
            if (!modal) return;
            _lastFocusedBeforeModal = document.activeElement;
            function onKey(e) {
                if (e.key === 'Escape') {
                    cerrarModal();
                    removeHandlers();
                    return;
                }
                if (e.key === 'Tab') {
                    // simple focus trap
                    const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (!focusable.length) return;
                    const first = focusable[0];
                    const last = focusable[focusable.length -1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            }
            function removeHandlers() {
                document.removeEventListener('keydown', onKey);
            }
            document.addEventListener('keydown', onKey);
            // ensure on close we restore focus
            const origClose = window.cerrarModal;
            window.cerrarModal = function() {
                try { removeHandlers(); } catch(e){}
                if (_lastFocusedBeforeModal) try { _lastFocusedBeforeModal.focus(); } catch(e){}
                modal.style.display = 'none'; document.body.classList.remove('modal-open');
            };
        }
        
        function cambiarCantidad(cambio) {
            if(!productoActual) return;
            let input = document.getElementById('cantidad-seleccionada');
            let val = parseInt(input.value, 10) + cambio;
            if (isNaN(val)) val = 1;
            if (val >= 1 && val <= 10) {
                input.value = val;
                document.getElementById('total-precio').innerText = formatearDinero(val * productoActual.precio);
            }
        }
        
        function enviarWhatsapp() {
            if(!productoActual) return;

            let variante = "Est√°ndar";
            const inputManualElem = document.getElementById('input-variante-manual');
            const hv = document.getElementById('variante-seleccionada-valor');
            if (inputManualElem) variante = inputManualElem.value;
            if (hv && hv.value) variante = hv.value;

            if (productoActual.sabores && (!hv || !hv.value)) { mostrarAlertaModal("‚ö†Ô∏è Elige un sabor"); return; }

            // Guardar en carrito para que la factura incluya el producto actual
            guardarEnCarrito(true);

            // Cerrar el modal antes de abrir el prompt de correo
            cerrarModal();

            // Lanzar el flujo de factura + WhatsApp
            setTimeout(() => {
                abrirPromptCorreo('modal');
            }, 100);
        }

        // Toggle favorite (heart) for current modal product
        function toggleFavorito() {
            if (!productoActual) return;
            const hv = document.getElementById('variante-seleccionada-valor');
            const inputManualElem = document.getElementById('input-variante-manual');
            const variante = (hv && hv.value) ? hv.value : (inputManualElem ? inputManualElem.value : productoActual.modelo);
            const icono = document.getElementById('icono-corazon-modal');
            const existeIndex = carrito.findIndex(item => item.id === productoActual.id && item.variante === variante);

            if (existeIndex === -1) {
                carrito.push({ id: productoActual.id, cantidad: 1, variante: variante, nombre: productoActual.nombre, precio: productoActual.precio, img: productoActual.img });
                icono.classList.remove('ph-shopping-cart-simple'); icono.classList.add('ph-shopping-cart'); icono.style.color = 'var(--gold-primary)';
            } else {
                carrito.splice(existeIndex, 1);
                icono.classList.remove('ph-shopping-cart'); icono.classList.add('ph-shopping-cart-simple'); icono.style.color = 'white';
            }
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            // Mantener sincron√≠a si la vista de carrito est√° abierta
            syncCarritoViewIfOpen();
        }

        // Floating cart UI
        function renderFloatingCart() {
            const list = document.getElementById('floating-cart-list');
            if (!list) return;
            try {
                list.innerHTML = '';
                if (carrito.length === 0) {
                    list.innerHTML = '<p style="padding:12px; color:#bbb">No hay productos en el carrito.</p>';
                    document.getElementById('floating-total').innerText = formatearDinero(0);
                    const advertencia = document.getElementById('sobre-pedido-advertencia');
                    if (advertencia) advertencia.style.display = 'none';
                    return;
                }
                let total = 0;
                carrito.forEach(it => {
                    total += (parseInt(it.cantidad,10) || 0) * it.precio;
                    const row = document.createElement('div');
                    row.className = 'floating-cart-item';
                    row.innerHTML = `
                        <img src="${it.img}" onerror="this.onerror=null;this.src='https://via.placeholder.com/48?text=VP'" alt="${it.nombre}">
                        <div class="fci-info">
                            <div class="fci-name">${it.nombre}</div>
                            <div class="fci-variant">${it.variante}</div>
                            <div class="fci-controls">
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${it.id}, '${encodeURIComponent(it.variante)}', -1)"><i class="ph ph-minus"></i></button>
                                <span class="fci-qty">${it.cantidad}</span>
                                <button class="btn-cant" type="button" onclick="event.stopPropagation(); updateItemCantidad(${it.id}, '${encodeURIComponent(it.variante)}', 1)"><i class="ph ph-plus"></i></button>
                            </div>
                        </div>
                        <div class="fci-right">
                            <div class="fci-price">${formatearDinero(it.precio * it.cantidad)}</div>
                            <button class="btn-eliminar" onclick="event.stopPropagation(); removeItem(${it.id}, '${encodeURIComponent(it.variante)}')" title="Eliminar">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(row);
                });
                document.getElementById('floating-total').innerText = formatearDinero(total);
                
                // Detectar si hay productos de "sobrepedido" en el carrito
                const tieneSobrePedido = carrito.some(it => {
                    const prod = listaProductos.find(p => p.id === it.id);
                    return prod && prod.categoria === 'sobrepedido';
                });
                
                // Mostrar/ocultar la advertencia seg√∫n productos
                const advertencia = document.getElementById('sobre-pedido-advertencia');
                if (advertencia) {
                    if (tieneSobrePedido) {
                        advertencia.style.display = 'flex';
                    } else {
                        advertencia.style.display = 'none';
                    }
                }
                
                // If panel was open, ensure it's visible (in case a render caused it to be hidden)
                const panelEl = document.getElementById('floating-cart-panel');
                if (panelEl && panelEl.classList.contains('open')) {
                    panelEl.style.display = 'block';
                    panelEl.setAttribute('aria-hidden','false');
                }
            } catch (e) {
                console.error('Error renderizando carrito flotante:', e);
                list.innerHTML = '<p style="padding:12px; color:#f2b84b">Ha ocurrido un error mostrando el carrito. Intenta abrirlo de nuevo.</p>';
                document.getElementById('floating-total').innerText = formatearDinero(0);
            }
        }

        function updateItemCantidad(id, varianteEnc, cambio) {
            const variante = decodeURIComponent(varianteEnc);
            const idx = carrito.findIndex(it => it.id === id && it.variante === variante);
            if (idx === -1) return;
            let nueva = Number(carrito[idx].cantidad) + Number(cambio);
            
            // Si la cantidad llega a 0 o menos, eliminar el producto del carrito
            if (nueva <= 0) {
                carrito.splice(idx, 1);
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
                
                // Actualizar el bot√≥n del modal si est√° abierto con este producto
                if (productoActual && productoActual.id === id) {
                    actualizarBotonModal();
                }
                
                // Si el carrito qued√≥ vac√≠o, recargar la p√°gina para reiniciar todo
                if (carrito.length === 0) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    return;
                }
                
                mostrarToast('Producto eliminado');
            } else {
                carrito[idx].cantidad = nueva;
                localStorage.setItem('vp_carrito', JSON.stringify(carrito));
                actualizarBadgeCarrito();
                renderFloatingCart();
            }
            
            // Actualizar la vista si el grid est√° visible: si el grid muestra el carrito, reabrirlo; si muestra otro filtro, re-renderizar ese filtro sin scroll
            if (document.getElementById('seccion-grid').style.display === 'block') {
                const cont = document.getElementById('grid-productos');
                if (cont && cont.querySelector('.carrito-header')) {
                    if (carrito.length > 0) {
                        abrirCarrito(true); // mantener sin scroll
                    }
                } else if (cont) {
                    const tituloEl = cont.querySelector('h2');
                    if (tituloEl) {
                        const filtro = tituloEl.innerText.toLowerCase();
                        cargarCatalogo(filtro, true);
                    }
                }
            }
        }

        function removeItem(id, varianteEnc) {
            const variante = decodeURIComponent(varianteEnc);
            carrito = carrito.filter(it => !(it.id === id && it.variante === variante));
            localStorage.setItem('vp_carrito', JSON.stringify(carrito));
            actualizarBadgeCarrito();
            renderFloatingCart();
            
            // Actualizar el bot√≥n del modal si est√° abierto con este producto
            if (productoActual && productoActual.id === id) {
                actualizarBotonModal();
            }
            
            // Actualizar la vista del carrito en grid si est√° abierta
            if (document.getElementById('seccion-grid').style.display === 'block') {
                const contenedor = document.getElementById('grid-productos');
                if (contenedor && contenedor.querySelector('.carrito-header')) {
                    if (carrito.length === 0) {
                        irAlInicio();
                    } else {
                        abrirCarrito();
                    }
                }
            }
        }

        function openFloatingCart() {
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            renderFloatingCart();
            panel.style.display = 'block';
            panel.classList.add('open');
            panel.setAttribute('aria-hidden','false');
            // focus en el input nombre si existe
            setTimeout(() => {
                const nombre = document.getElementById('fc-name');
                if (nombre) nombre.focus();
            }, 150);
        }

        function toggleFloatingCart() {
            if(carrito.length === 0) {
                mostrarAlertaModal("Tu carrito est√° vac√≠o. ¬°Agrega productos!");
                return;
            }
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            
            // Si est√° visible, cerrarlo
            if (panel.style.display === 'block' || panel.classList.contains('open')) {
                closeFloatingCart();
            } else {
                // Si est√° oculto, abrirlo
                openFloatingCart();
            }
        }

        function closeFloatingCart() {
            const panel = document.getElementById('floating-cart-panel');
            if (!panel) return;
            panel.classList.remove('open');
            panel.setAttribute('aria-hidden','true');
            // esperar la animaci√≥n y ocultar
            setTimeout(() => { panel.style.display = 'none'; }, 220);
            // devolver foco al bot√≥n whatsapp
            const btn = document.getElementById('whatsapp-floating');
            if (btn) btn.focus();
        }

        // Flujo principal: capturar correo y luego enviar pedido completo por WhatsApp
        function sendWholeOrderWhatsApp() {
            if (carrito.length === 0) { mostrarAlertaModal('El carrito est√° vac√≠o'); return; }
            abrirPromptCorreo('carrito');
        }

        // Construye mensaje de WhatsApp para el carrito completo
        function construirMensajeCarrito() {
            if (carrito.length === 0) { mostrarAlertaModal('El carrito est√° vac√≠o'); return null; }

            const folio = Math.floor(1000 + Math.random() * 9000);
            let lines = [];
            lines.push(`üìù *PEDIDO #${folio}*`);
            lines.push('');

            let total = 0;
            let totalSobrePedido = 0;
            let productosSobrePedido = [];
            let productosNormales = [];

            carrito.forEach((it) => {
                try {
                    const producto = listaProductos.find(p => p.id === it.id);
                    const esSobrePedido = producto && producto.categoria === 'sobrepedido';
                    const subtotal = (parseInt(it.cantidad,10) || 0) * it.precio;
                    total += subtotal;

                    const itemText = `‚Ä¢ ${it.nombre} (${it.variante})\n  x${it.cantidad} - ${formatearDinero(subtotal)}`;

                    if (esSobrePedido) {
                        productosSobrePedido.push(itemText);
                        totalSobrePedido += subtotal;
                    } else {
                        productosNormales.push(itemText);
                    }
                } catch (e) {
                    console.warn('Item inv√°lido en carrito:', e, it);
                }
            });

            if (productosNormales.length > 0) {
                productosNormales.forEach(item => lines.push(item));
            }

            if (productosSobrePedido.length > 0) {
                if (productosNormales.length > 0) lines.push('');
                lines.push('‚ö†Ô∏è *SOBRE PEDIDO:*');
                productosSobrePedido.forEach(item => lines.push(item));
                lines.push(`üíµ Anticipo (50%): *${formatearDinero(totalSobrePedido * 0.5)}*`);
                lines.push('üìÖ Entrega: ~9 d√≠as');
            }

            lines.push('');
            lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            lines.push(`üí∞ *TOTAL: ${formatearDinero(total)}*`);
            lines.push('');
            lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            lines.push('üè¶ *DATOS PARA TRANSFERENCIA:*');
            lines.push('Banco: *Santander*');
            lines.push('Tarjeta: *5579 0790 0594 2705*');
            lines.push('Concepto: *Tu nombre + pago*');
            lines.push('Ejemplo: _Carlos, pago_');
            lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

            return { mensaje: lines.join('\n'), folio };
        }

        // Construye mensaje de WhatsApp para el producto del modal
        function construirMensajeModal() {
            if (!productoActual) { mostrarAlertaModal('Selecciona un producto.'); return null; }

            const hv = document.getElementById('variante-seleccionada-valor');
            const inputManualElem = document.getElementById('input-variante-manual');
            let variante = 'Est√°ndar';
            if (inputManualElem) variante = inputManualElem.value;
            if (hv && hv.value) variante = hv.value;

            if (productoActual.sabores && (!hv || !hv.value)) { mostrarAlertaModal('‚ö†Ô∏è Elige un sabor'); return null; }

            const cantidad = parseInt(document.getElementById('cantidad-seleccionada').value, 10) || 1;
            const pago = document.querySelector('input[name="pago"]:checked').value;
            const total = cantidad * productoActual.precio;
            const folio = Math.floor(1000 + Math.random() * 9000);
            const esSobrePedido = productoActual.categoria === 'sobrepedido';

            let mensaje = `*PEDIDO #${folio}*\n\n`;
            if (esSobrePedido) {
                mensaje += '‚ö†Ô∏è *SOBRE PEDIDO:*\n';
            }

            mensaje += `${productoActual.nombre} (${variante}) x${cantidad} - ${formatearDinero(total)}\n`;

            if (esSobrePedido) {
                mensaje += `Anticipo 50%: ${formatearDinero(total * 0.5)}\n`;
                mensaje += 'Entrega: 7 d√≠as aprox.\n';
            }

            mensaje += `\nüí≥ Pago: ${pago}\n`;
            
            // Si es transferencia, agregar datos bancarios
            if (pago === 'Transferencia') {
                mensaje += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
                mensaje += `\nüè¶ *DATOS PARA TRANSFERENCIA:*\n`;
                mensaje += `Banco: *Santander*\n`;
                mensaje += `Tarjeta: *5579 0790 0594 2705*\n`;
                mensaje += `Concepto: *Tu nombre + pago*\n`;
                mensaje += `Ejemplo: _Carlos, pago_\n`;
                mensaje += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;
            }
            
            mensaje += `\n*Total: ${formatearDinero(total)}*`;

            return { mensaje, folio };
        }

        // Construye HTML para la factura del modal (un solo producto)
        function generarFacturaModalHTML(folio) {
            if (!productoActual) return { html: '', total: 0 };

            const hv = document.getElementById('variante-seleccionada-valor');
            const inputManualElem = document.getElementById('input-variante-manual');
            let variante = 'Est√°ndar';
            if (inputManualElem) variante = inputManualElem.value;
            if (hv && hv.value) variante = hv.value;

            const cantidad = parseInt(document.getElementById('cantidad-seleccionada').value, 10) || 1;
            const total = cantidad * productoActual.precio;
            const esSobrePedido = productoActual.categoria === 'sobrepedido';
            const anticipo = esSobrePedido ? total * 0.5 : 0;

            const html = `
                <div style="font-family: Arial, sans-serif; color:#222;">
                    <h2 style="margin:0 0 12px 0;">Factura / Pedido #${folio}</h2>
                    ${!esSobrePedido ? `<div style="margin-bottom:12px;"><h4 style="margin:0 0 6px 0;">Productos</h4><ul style="padding-left:18px;"><li><strong>${productoActual.nombre}</strong> (${variante}) x${cantidad}: ${formatearDinero(total)}</li></ul></div>` : ''}
                    ${esSobrePedido ? `<div style="margin-bottom:12px;"><h4 style="margin:0 0 6px 0;">Sobre pedido</h4><ul style="padding-left:18px;"><li><strong>${productoActual.nombre}</strong> (${variante}) x${cantidad}: ${formatearDinero(total)}</li></ul><p style="margin:4px 0;">Anticipo 50%: <strong>${formatearDinero(anticipo)}</strong></p><p style="margin:4px 0;">Entrega estimada: ~7 d√≠as</p></div>` : ''}
                    <hr style="border:none; border-top:1px solid #ddd; margin:12px 0;">
                    <p style="margin:0; font-size:1.05rem;">Total: <strong>${formatearDinero(total)}</strong></p>
                    <div style="background:#f0f9ff; border:2px solid #0284c7; border-radius:8px; padding:16px; margin-top:20px;">
                        <h3 style="margin:0 0 10px 0; color:#0369a1; font-size:1.1rem;">üè¶ Datos para Transferencia</h3>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Banco:</strong> Santander</p>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Tarjeta:</strong> 5579 0790 0594 2705</p>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Concepto:</strong> Tu nombre + pago</p>
                        <p style="margin:6px 0; font-size:0.9rem; color:#666; font-style:italic;">Ejemplo: Carlos, pago</p>
                    </div>
                </div>`;

            return { html, total };
        }

        // Construye HTML para la factura a enviar por email
        function generarFacturaHTML(folio) {
            let total = 0;
            let totalSobrePedido = 0;
            let productosSobrePedido = [];
            let productosNormales = [];

            carrito.forEach((it) => {
                const prod = listaProductos.find(p => p.id === it.id);
                const esSobrePedido = prod && prod.categoria === 'sobrepedido';
                const subtotal = (parseInt(it.cantidad,10) || 0) * it.precio;
                total += subtotal;
                const linea = `<li><strong>${it.nombre}</strong> (${it.variante}) x${it.cantidad}: ${formatearDinero(subtotal)}</li>`;
                if (esSobrePedido) {
                    productosSobrePedido.push(linea);
                    totalSobrePedido += subtotal;
                } else {
                    productosNormales.push(linea);
                }
            });

            const anticipo = totalSobrePedido > 0 ? totalSobrePedido * 0.5 : 0;
            const html = `
                <div style="font-family: Arial, sans-serif; color:#222;">
                    <h2 style="margin:0 0 12px 0;">Factura / Pedido #${folio}</h2>
                    ${productosNormales.length ? `<div style="margin-bottom:12px;"><h4 style="margin:0 0 6px 0;">Productos</h4><ul style="padding-left:18px;">${productosNormales.join('')}</ul></div>` : ''}
                    ${productosSobrePedido.length ? `<div style="margin-bottom:12px;"><h4 style="margin:0 0 6px 0;">Sobre pedido</h4><ul style="padding-left:18px;">${productosSobrePedido.join('')}</ul><p style="margin:4px 0;">Anticipo 50%: <strong>${formatearDinero(anticipo)}</strong></p><p style="margin:4px 0;">Entrega estimada: ~7 d√≠as</p></div>` : ''}
                    <hr style="border:none; border-top:1px solid #ddd; margin:12px 0;">
                    <p style="margin:0; font-size:1.05rem;">Total: <strong>${formatearDinero(total)}</strong></p>
                    <div style="background:#f0f9ff; border:2px solid #0284c7; border-radius:8px; padding:16px; margin-top:20px;">
                        <h3 style="margin:0 0 10px 0; color:#0369a1; font-size:1.1rem;">üè¶ Datos para Transferencia</h3>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Banco:</strong> Santander</p>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Tarjeta:</strong> 5579 0790 0594 2705</p>
                        <p style="margin:6px 0; font-size:0.95rem;"><strong>Concepto:</strong> Tu nombre + pago</p>
                        <p style="margin:6px 0; font-size:0.9rem; color:#666; font-style:italic;">Ejemplo: Carlos, pago</p>
                    </div>
                </div>`;

            return { html, total };
        }

        // Env√≠a la factura por email usando Apps Script
        async function enviarFacturaPorCorreo(correoCliente, folio, action) {
            if (!correoCliente) throw new Error('EMAIL_REQUERIDO');
            if (carrito.length === 0) throw new Error('CARRITO_VACIO');

            const ahora = Date.now();
            if (ahora < _emailCooldownUntil) throw new Error('COOLDOWN');

            const { html } = action === 'modal' ? generarFacturaModalHTML(folio) : generarFacturaHTML(folio);
            const payload = {
                to: correoCliente,
                cc: EMAIL_CC,
                asunto: `Factura pedido #${folio}`,
                mensaje: html
            };

            console.log('üìß Enviando factura al endpoint:', EMAIL_ENDPOINT);
            console.log('üì¶ Payload:', payload);

            try {
                const resp = await fetch(EMAIL_ENDPOINT, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para Apps Script
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('‚úÖ Respuesta recibida:', resp);
                
                // Con no-cors no podemos leer la respuesta, asumimos √©xito si no hay error
                _emailCooldownUntil = ahora + EMAIL_COOLDOWN_MS;
                return true;
            } catch (error) {
                console.error('‚ùå Error al enviar factura:', error);
                throw new Error('ENVIO_FALLIDO');
            }
        }

        // Orquesta el flujo: factura -> WhatsApp
        async function procesarAccionConCorreo(correoCliente, action) {
            if (!action) { mostrarAlertaModal('No se pudo iniciar el env√≠o. Intenta de nuevo.'); return; }

            const build = action === 'carrito' ? construirMensajeCarrito() : construirMensajeModal();
            if (!build) { return; }

            const { mensaje, folio } = build;

            try {
                mostrarToast('Enviando factura...');
                await enviarFacturaPorCorreo(correoCliente, folio, action);
                mostrarToast('Factura enviada. Abriendo WhatsApp...');
                const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(mensaje)}`;
                window.open(url, '_blank');
            } catch (err) {
                console.error('procesarAccionConCorreo', err);
                if (err && err.message === 'COOLDOWN') {
                    mostrarToast('Espera unos segundos antes de reenviar la factura.');
                } else if (err && err.message === 'CARRITO_VACIO') {
                    mostrarAlertaModal('Tu carrito est√° vac√≠o.');
                    return;
                } else {
                    mostrarToast('No pudimos confirmar el env√≠o de la factura. Abriremos WhatsApp igual.');
                }

                // Fallback: abrir WhatsApp aunque el correo falle, para no bloquear la compra
                try {
                    const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, '_blank');
                } catch (openErr) {
                    console.error('No se pudo abrir WhatsApp tras error de factura', openErr);
                    mostrarAlertaModal('No se pudo abrir WhatsApp. Intenta nuevamente.');
                }
            } finally {
                _pendingAction = null;
            }
        }

        window.onload = function() { cargarCarritoDelStorage(); iniciarTicker(); renderizarMenuInicio(); actualizarBadgeCarrito(); };
    </script>
</body>
</html>

